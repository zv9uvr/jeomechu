<script>
    // 카카오 지도 API 초기화
    var mapContainer = document.getElementById('map'), // 지도를 표시할 div
        mapOption = {
            center: new kakao.maps.LatLng(37.5665, 126.9780), // 기본 위치: 서울
            level: 5 // 지도의 확대 레벨
        };

    var map = new kakao.maps.Map(mapContainer, mapOption);
    var ps = new kakao.maps.services.Places(); // 장소 검색 객체 생성
    var infowindow = new kakao.maps.InfoWindow({ zIndex: 1 }); // 정보 창 객체 생성

    // 사용자가 입력한 위치를 기준으로 설정하는 함수
    function setLocation() {
        var location = document.getElementById('location-input').value;
        
        if (!location) {
            alert('지역을 입력해 주세요.');
            return;
        }
        
        // 입력한 위치를 기준으로 검색
        ps.keywordSearch(location, function(data, status) {
            if (status === kakao.maps.services.Status.OK) {
                var center = new kakao.maps.LatLng(data[0].y, data[0].x);
                
                map.setCenter(center); // 지도 중심 이동
                searchPlaces(selectedCategory, center); // 선택된 음식 종류와 중심 위치로 검색
            } else {
                alert('입력한 지역을 찾을 수 없습니다.');
            }
        });
    }

    // 음식 종류를 저장하는 변수
    var selectedCategory = '';

    // 음식 종류에 따라 검색
    function searchPlaces(category, center) {
        selectedCategory = category;

        var options = {
            location: center, // 사용자가 설정한 위치
            radius: 1000, // 반경 1KM
            category_group_code: '' // 한식, 중식, 양식, 일식 등 음식 종류에 따라 빈 값으로 설정
        };

        switch (category) {
            case '한식':
                options.category_group_code = 'FD6';
                break;
            case '중식':
                options.category_group_code = 'FD6';
                break;
            case '양식':
                options.category_group_code = 'FD6';
                break;
            case '일식':
                options.category_group_code = 'FD6';
                break;
        }

        ps.categorySearch(category, placesSearchCB, options);
    }

    // 장소 검색 콜백 함수
    function placesSearchCB(data, status) {
        if (status === kakao.maps.services.Status.OK) {
            displayPlaces(data); // 검색 결과를 화면에 표시
        } else {
            alert('검색 결과가 없습니다.');
        }
    }

    // 검색 결과 표시
    function displayPlaces(places) {
        var listEl = document.getElementById('restaurant-list');
        listEl.innerHTML = ''; // 기존 검색 결과 삭제

        // 검색 결과 마커와 정보창을 생성
        for (var i = 0; i < places.length; i++) {
            var place = places[i];
            var placePosition = new kakao.maps.LatLng(place.y, place.x);
            
            // 마커 표시
            var marker = new kakao.maps.Marker({
                map: map,
                position: placePosition
            });

            // 음식점 목록 추가
            var itemEl = document.createElement('div');
            itemEl.className = 'restaurant-item';
            itemEl.innerText = place.place_name;
            listEl.appendChild(itemEl);

            (function(marker, place) {
                kakao.maps.event.addListener(marker, 'click', function() {
                    infowindow.setContent('<div>' + place.place_name + '</div>');
                    infowindow.open(map, marker);
                });
            })(marker, place);
        }
    }

    // 초기화 기능
    function resetRestaurants() {
        document.getElementById('restaurant-list').innerHTML = '';
        map.setCenter(new kakao.maps.LatLng(37.5665, 126.9780)); // 서울로 초기화
        selectedCategory = '';
    }
</script>
